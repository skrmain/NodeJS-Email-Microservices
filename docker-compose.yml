services:
    rabbitmq:
        container_name: rabbitmq
        image: rabbitmq:3.10-management-alpine
        environment:
            - RABBITMQ_DEFAULT_USER=admin
            - RABBITMQ_DEFAULT_PASS=admin
        ports:
            - 5672:5672 # AMQP protocol port
            - 15672:15672 # HTTP management UI

    email-service:
        build:
            context: ./email-service/
            dockerfile: Dockerfile
        volumes:
            - ./email-service/src:/app/src
        environment:
            - QUEUE_URL=amqp://admin:admin@rabbitmq
            - QUEUE=nodemailer-amqp
            - SMTP_PORT=12345
            - SMTP_HOSTNAME=my-smtp-server
        depends_on:
            - rabbitmq
            - my-smtp-server

    my-smtp-server:
        build:
            context: ./my-smtp-server/
            dockerfile: Dockerfile
        volumes:
            - ./my-smtp-server/src:/app/src
        ports:
            - 12345:12345

    server:
        build:
            context: ./server/
            dockerfile: Dockerfile
        volumes:
            - ./server/src:/app/src
        ports:
            - 8000:8000
        environment:
            - QUEUE_URL=amqp://admin:admin@rabbitmq
            - QUEUE=test
        depends_on:
            - rabbitmq
